{{ $docs := .Site.Data.PluginGoDocs }}

{{ define "TypeString" }}
    {{- if hasPrefix . "[]" }}[]{{ template "TypeString" (strings.TrimPrefix "[]" .) }}
    {{- else if hasPrefix . "*"}}*{{ template "TypeString" (strings.TrimPrefix "*" .) }}
    {{- else }}{{ index (split . "/" | last 1) 0 }}
    {{- end -}}
{{ end }}

{{ define "TypeHTML" }}
    {{- $builtInTypes := slice "bool" "byte" "complex128" "complex64" "error" "float32" "float64" "int" "int16" "int32" "int64" "int8" "rune" "string" "uint" "uint16" "uint32" "uint64" "uint8" "uintptr" -}}
    {{- if in $builtInTypes . }}<a href="https://godoc.org/builtin#{{ . }}">{{ . }}</a>
    {{- else if hasPrefix . "[]" }}[]{{ template "TypeHTML" (strings.TrimPrefix "[]" .) }}
    {{- else if hasPrefix . "*" }}*{{ template "TypeHTML" (strings.TrimPrefix "*" .) }}
    {{- else if in . "." -}}
        {{- $name := index (split . "." | last 1) 0 }}
        {{- $package := strings.TrimSuffix $name . | strings.TrimSuffix "." -}}
        <a href="https://godoc.org/{{ $package }}" target="_blank">{{ index (split $package "/" | last 1) 0 }}</a>.<a href="https://godoc.org/{{ $package }}#{{ $name }}" target="_blank">{{ $name }}</a>
    {{- else }}{{ range split . "/" | last 1 }}{{ . }}{{ end }}
    {{- end -}}
{{ end }}

{{ define "FieldsString" }}
    {{- if . -}}
        {{- range $index, $field := . -}}
            {{- if ne $index 0 }}, {{ end -}}
            {{- if $field.Names }}{{ delimit $field.Names ", " }} {{ end }}{{ template "TypeString" $field.Type -}}
        {{- end -}}
    {{- end -}}
{{ end }}

{{ define "FieldsHTML" }}
    {{- if . -}}
        {{- range $index, $field := . -}}
            {{- if ne $index 0 }}, {{ end -}}
            {{- if $field.Names }}{{ delimit $field.Names ", " }} {{ end }}{{ template "TypeHTML" $field.Type -}}
        {{- end -}}
    {{- end -}}
{{ end }}

{{ define "ParenthesizedResults" }}
    {{- if .Remaining -}}
        {{- $nextFieldCount := or (index .Remaining 0).Names (slice "_") | len -}}
        {{- if gt (len .Remaining) 1 -}}
            {{- template "ParenthesizedResults" dict "Count" (add .Count $nextFieldCount) "HTML" .HTML "Remaining" (after 1 .Remaining) "Results" .Results -}}
        {{- else -}}
            {{- template "ParenthesizedResults" dict "Count" (add .Count $nextFieldCount) "HTML" .HTML "Remaining" (slice) "Results" .Results -}}
        {{- end -}}
    {{- else -}}
        {{- if gt .Count 1 }}({{ end -}}
        {{- if .HTML }}{{ template "FieldsHTML" .Results }}{{ else }}{{ template "FieldsString" .Results }}{{ end -}}
        {{- if gt .Count 1 }}){{ end -}}
    {{- end -}}
{{ end }}

{{ define "ResultsString" }}{{ template "ParenthesizedResults" dict "Count" 0 "HTML" false "Remaining" . "Results" . }}{{ end }}
{{ define "ResultsHTML" }}{{ template "ParenthesizedResults" dict "Count" 0 "HTML" true "Remaining" . "Results" . }}{{ end }}

{{ define "FunctionSignatureHTML" }}
    <pre><code>
        {{- .Name }}({{ template "FieldsHTML" .Parameters }}) {{ template "ResultsHTML" .Results -}}
    </code></pre>
{{ end }}

{{ define "InterfaceTOC" }}
    <ul>
        {{ range .Interface.Methods }}
        <li><a href="#{{ $.Name}}.{{ .Name }}">{{ .Name }}({{ template "FieldsString" .Parameters }}) {{ template "ResultsString" .Results }}</a></li>
        {{ end }}
    </ul>
{{ end }}

{{ define "InterfaceMethodDocs" }}
    {{ range .Interface.Methods }}
        <div>
            <h1 id="{{ $.Name }}.{{ .Name }}">({{ $.Name }}) {{ .Name }}</h1>
            <p>{{ template "FunctionSignatureHTML" . }}</p>
            <p>{{ markdownify .Comment }}</p>
        </div>
    {{ end }}
{{ end }}

{{ if $docs }}
    <div>
        <div>
            <h1>API</h1>
            <p>{{ markdownify $docs.API.Comment }}</p>
            {{ template "InterfaceTOC" dict "Name" "API" "Interface" $docs.API }}
        </div>
        <div>
            <h1>Hooks</h1>
            <p>{{ markdownify $docs.Hooks.Comment }}</p>
            {{ template "InterfaceTOC" dict "Name" "Hooks" "Interface" $docs.Hooks }}
        </div>
        <hr />
        {{ template "InterfaceMethodDocs" dict "Name" "API" "Interface" $docs.API }}
        {{ template "InterfaceMethodDocs" dict "Name" "Hooks" "Interface" $docs.Hooks }}
    </div>
{{ else }}
    Run <code>make plugin-godocs</code> to generate this documentation.
{{ end }}
